---
import LibraryLayout from '../../../layouts/LibraryLayout.astro';
import BookDetail from '../../../components/library/BookDetail';
import Sidebar from '../../../components/library/Sidebar';
import Header from '../../../components/Header.astro';
import { mockBooks } from '../../../data/mock-books';
import { groupByGenre } from '../../../lib/library-utils';

export function getStaticPaths() {
  return mockBooks.map(b => ({ params: { id: b.id.toString() } }));
}

const { id } = Astro.params;
const book = mockBooks.find(b => b.id.toString() === id);

if (!book) {
  return Astro.redirect('/library');
}

const genres = groupByGenre(mockBooks);
const relatedBooks = mockBooks
    .filter(b => b.genre === book.genre && b.id !== book.id)
    .slice(0, 5);

const title = `${book.title} | Library`;
const description = book.description;
const permalink = Astro.site ? `${Astro.site}library/book/${id}` : `/library/book/${id}`;
---

<LibraryLayout title={title} description={description} permalink={permalink}>
  <div class="flex min-h-screen bg-[var(--layout-bg)]">
    <Sidebar genres={genres} activeGenre={book.genre} client:load />
    
    <main class="flex-1 py-8 px-6 md:px-10 relative z-0 md:ml-[280px]">
        <div class="mb-8">
          <Header current="library" />
        </div>

        <div class="max-w-7xl mx-auto">
          <BookDetail book={book} relatedBooks={relatedBooks} client:load />
        </div>
    </main>
  </div>
</LibraryLayout>
