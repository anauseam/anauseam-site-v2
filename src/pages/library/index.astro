---
export const prerender = false;

import LibraryLayout from '../../layouts/LibraryLayout.astro';
import BooksList from '../../components/library/BooksList';
import Sidebar from '../../components/library/Sidebar';
import Header from '../../components/Header.astro';
import { groupByGenre } from '../../lib/library-utils';

const title = "Library | Anauseam";
const description = "My personal library of books.";
const permalink = Astro.site ? `${Astro.site}library` : '/library';

let books = [];

// Try to fetch from D1 first
if (Astro.locals.runtime?.env?.DB) {
  try {
    const db = Astro.locals.runtime.env.DB;
    
    // Fetch Projects
    const projectsResult = await db.prepare('SELECT * FROM projects ORDER BY created_at DESC').all();
    const projects = (projectsResult.results || []).map(p => ({
      id: `proj-${p.id}`, 
      title: p.name,
      author: p.language || 'Software',
      description: p.description,
      image_url: '/assets/home-illustration-small.webp', // Placeholder
      genre: 'Software Project',
      created_at: p.created_at
    }));

    // Fetch Reports
    const reportsResult = await db.prepare('SELECT * FROM reports ORDER BY created_at DESC').all();
    const reports = (reportsResult.results || []).map(r => ({
      id: `rep-${r.id}`,
      title: r.title,
      author: r.author || 'Anauseam',
      description: r.summary,
      image_url: '/assets/about-illustration.webp', // Placeholder
      genre: 'Analysis',
      created_at: r.created_at
    }));

    books = [...projects, ...reports];
  } catch (e) {
    console.error("Error fetching from D1:", e);
  }
} else {
  // Fallback for development without D1 binding
  console.warn("No D1 binding found, using mock data");
  const { mockBooks } = await import('../../data/mock-books');
  books = mockBooks;
}

const genres = groupByGenre(books);
---

<LibraryLayout title={title} description={description} permalink={permalink}>
  <div class="flex min-h-screen bg-[var(--layout-bg)]">
    <Sidebar genres={genres} client:load />
    
    <main class="flex-1 py-8 px-6 md:px-10 relative z-0 md:ml-[280px]">
        <div class="mb-8">
          <Header current="library" />
        </div>
        
        <div class="max-w-7xl mx-auto">
          <div class="page-header mb-12">
              <h1 class="text-3xl md:text-4xl font-bold text-[var(--text-main)] font-serif mb-6 leading-tight">Library</h1>
              <p class="text-[var(--text-main)] leading-relaxed mb-4 opacity-80">Library of projects and analyses</p>
          </div>
          
          <BooksList books={books} client:load />
        </div>
    </main>
  </div>
</LibraryLayout>
